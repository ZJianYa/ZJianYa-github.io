# 概述

## 参数

-XX:+UseSerialGC

## 常见问题

表症多种，可能异病同治，同病异治  
常见原因：内存设置太小，比例不合适，内存泄露  

### 调优之前

对 JVM 的了解是优化的前提  
对 JVM 的了解重点是  GC  
GC : 1. GC 算法  2. GC 工具的使用和监控 3. GC 日志解读 4. GC 参数调优  

高内存/高CPU：可能是性能问题，可能是内存泄露，也可能是参数不合理。  
高内存/低CPU：是内存泄露的可能性比较大。  
低内存/高CPU：编码问题，比如正则表达式没有写好。  

#### 调优的目标

延时、吞吐量。  

### OOM

### GC时长太长

谈到调优，这一定是针对特定场景、特定目的的事情， 对于 GC 调优来说，首先就需要清楚调优的目标是什么？从性能的角度看，通常关注三个方面，内存占用（footprint）、延时（latency）和吞吐量（throughput），大多数情况下调优会侧重于其中一个或者两个方面的目标，很少有情况可以兼顾三个不同的角度。当然，除了上面通常的三个方面，也可能需要考虑其他 GC 相关的场景，例如，OOM 也可能与不合理的 GC 相关参数有关；或者，应用启动速度方面的需求，GC 也会是个考虑的方面。

- 理解应用需求和问题，确定调优目标。假设，我们开发了一个应用服务，但发现偶尔会出现性能抖动，出现较长的服务停顿。评估用户可接受的响应时间和业务量，将目标简化为，希望 GC 暂停尽量控制在 200ms 以内，并且保证一定标准的吞吐量。
- 掌握 JVM 和 GC 的状态，定位具体的问题，确定真的有 GC 调优的必要。具体有很多方法，比如，通过 jstat 等工具查看 GC 等相关状态，可以开启 GC 日志，或者是利用操作系统提供的诊断工具等。例如，通过追踪 GC 日志，就可以查找是不是 GC 在特定时间发生了长时间的暂停，进而导致了应用响应不及时。
- 这里需要思考，选择的 GC 类型是否符合我们的应用特征，如果是，具体问题表现在哪里，是 Minor GC 过长，还是 Mixed GC 等出现异常停顿情况；如果不是，考虑切换到什么类型，如 CMS 和 G1 都是更侧重于低延迟的 GC 选项。
- 通过分析确定具体调整的参数或者软硬件配置。
- 验证是否达到调优目标，如果达到目标，即可以考虑结束调优；否则，重复完成分析、调整、验证这个过程。

## 常规解决思路

jstat 查看 GC 状态 

### 大前提

- 确认不是DB的问题，不是前端的问题，不是网络的问题，不是算法的问题

### 分析JVM

能线下解决的当然线下解决比较好

- 排查最近上线的功能
- 是否需要压测重现，需要的话则开启压测
- 测试环境通过可视化工具检测  
  对于OOM的情况，可以查看线程内存占用情况  
  对于GC时间过长，可以查看内存分配情况，调整内存分配比例  
- 通过日志分析定位  

#### 开启日志

打开 GC 日志

-XX:+PrintGCDetails
-XX:+PrintGCDateStamps

上面这两项在 JDK 9 中已经分别被废弃和移除。可以使用 `java -Xlog:help` 替代

-XX:+PrintAdaptiveSizePolicy // 打印 G1 Ergonomics 相关信息

我们知道 GC 内部一些行为是适应性的触发的，利用 PrintAdaptiveSizePolicy，我们就可以知道为什么 JVM 做出了一些可能我们不希望发生的动作。例如，G1 调优的一个基本建议就是避免进行大量的 Humongous 对象分配，如果 Ergonomics 信息说明发生了这一点，那么就可以考虑要么增大堆的大小，要么直接将 region 大小提高。

如果是怀疑出现引用清理不及时的情况，则可以打开下面选项，掌握到底是哪里出现了堆积。

-XX:+PrintReferenceGC

另外，建议开启选项下面的选项进行并行引用处理。

-XX:+ParallelRefProcEnabled

#### 针对情况做处理

- Young GC

如果发现 Young GC 非常耗时，这很可能就是因为新生代太大了，我们可以考虑减小新生代的最小比例。

-XX:G1NewSizePercent

降低其最大值同样对降低 Young GC 延迟有帮助。

-XX:G1MaxNewSizePercent

如果我们直接为 G1 设置较小的延迟目标值，也会起到减小新生代的效果，虽然会影响吞吐量。  

- Mixed GC

还记得前面说的，部分 Old region 会被包含进 Mixed GC，减少一次处理的 region 个数，就是个直接的选择之一。  

 我在上面已经介绍了 `G1OldCSetRegionThresholdPercent` 控制其最大值，还可以利用下面参数提高 Mixed GC 的个数，当前默认值是 8，Mixed GC 数量增多，意味着每次被包含的 region 减少。

 -XX:G1MixedGCCountTarget

## TODO

- 常见的原因，比如内存分配不足，分配比例不恰当
- 内存泄漏现象